---
- block:
    - name: Install ZSH
      ansible.builtin.apt:
        name: zsh
        state: latest

    - name: Set ZSH as the default shell
      ansible.builtin.user:
        name: "{{ user }}"
        shell: /usr/bin/zsh

    - name: Check if .oh-my-zsh directory exists
      ansible.builtin.stat:
        path: /home/{{ user }}/.oh-my-zsh
      register: oh_my_zsh_dir

    - name: Install oh-my-zsh
      ansible.builtin.shell: |
        curl -fsL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh | bash
      args:
        warn: false
      become_user: "{{ user }}"
      when: not oh_my_zsh_dir.stat.exists

    - name: Copy ZSH custom aliases to oh-my-zsh custom directory
      ansible.builtin.copy:
        src: "dotfiles/.aliases"
        dest: "{{ homedir }}/.oh-my-zsh/custom/aliases.zsh"
        remote_src: true
        mode: 0775

    - name: Change ZSH theme to {{ zsh_theme }}
      ansible.builtin.lineinfile:
        path: "/home/{{ user }}/.zshrc"
        regexp: "^ZSH_THEME="
        line: "ZSH_THEME={{ zsh_theme }}"
  when: install_zsh | bool
