---
- name: Install ZSH
  ansible.builtin.apt:
    name: zsh
    state: present

- name: Set ZSH as the default shell
  ansible.builtin.user:
    name: "{{ user }}"
    shell: /usr/bin/zsh

- name: Set up oh-my-zsh
  block:
    - name: Check if .oh-my-zsh directory exists
      ansible.builtin.stat:
        path: /home/{{ user }}/.oh-my-zsh
      register: oh_my_zsh_dir

    - name: Install oh-my-zsh
      ansible.builtin.shell: |
        set -o pipefail
        curl -fsL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh | bash
      args:
        executable: /usr/bin/env bash
      become: false
      become_user: "{{ user }}"
      register: oh_my_zsh_output
      changed_when: "'folder already exists' not in oh_my_zsh_output.stdout"
      when: not oh_my_zsh_dir.stat.exists

    - name: Install oh-my-zsh Powerlevel10k theme
      ansible.builtin.git:
        repo: https://github.com/romkatv/powerlevel10k.git
        dest: "/home/{{ user }}/.oh-my-zsh/custom/themes/powerlevel10k"
        depth: 1
        version: master

    - name: Copy oh-my-zsh Powerlevel10k theme config
      ansible.builtin.copy:
        src: "dotfiles/.p10k.zsh"
        dest: "{{ homedir }}"
        remote_src: true
        mode: "0775"

    - name: Install zsh-autocomplete plugin
      ansible.builtin.git:
        repo: https://github.com/marlonrichert/zsh-autocomplete.git
        dest: "/home/{{ user }}/.oh-my-zsh/custom/plugins/zsh-autocomplete"
        depth: 1
        version: main

    - name: Set oh-my-zsh plugins
      ansible.builtin.lineinfile:
        path: "/home/{{ user }}/.zshrc"
        regexp: "^plugins="
        line: "plugins=({{ zsh.oh_my_zsh_plugins }})"

    - name: Add kube-ps1 to the prompt
      ansible.builtin.lineinfile:
        path: "/home/{{ user }}/.zshrc"
        regexp: "^PROMPT="
        line: "PROMPT='$(kube_ps1)'$PROMPT"

    - name: Copy ZSH custom aliases to oh-my-zsh custom directory
      ansible.builtin.copy:
        src: "dotfiles/.aliases"
        dest: "{{ homedir }}/.oh-my-zsh/custom/aliases.zsh"
        remote_src: true
        mode: "0775"

    - name: Change ZSH theme to {{ zsh.theme }}
      ansible.builtin.lineinfile:
        path: "/home/{{ user }}/.zshrc"
        regexp: "^ZSH_THEME="
        line: "ZSH_THEME={{ zsh.theme }}"
